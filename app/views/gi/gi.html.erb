<div id="titulo" class="centro">
  <table id="t_titulo"><tr>
    <td id="tabla" style="font-size: 1.2em; font-weight: bold">&nbsp;</td>
    <td style="font-size: 1.6em; font-weight: bold"> <%= @titulo %> </td>
    <td id="botones">&nbsp;</td>
  </tr></table>
</div>

<div id="solapas">
  <ul>
    <% @tablas.each_key do |mod| %>
      <li><a href="#<%= mod %>"> <%= nt(mod) %> </a></li>
    <% end %>
  </ul>

  <% @tablas.each do |mod, tab| %>
    <div id="<%= mod %>">
      <ul id="<%= mod %>_m">
        <% tab.each do |t| %>
          <li id="<%= t %>"> <%= nt(t) %> </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>

<div id="param">
  <div id="campos">
    <p class="tit"> Campos </p>
    <div id="tree_campos"> </div>
  </div>

  <div id="formus">
    <div id="f_cmp">
      <table>
        <tr><td class="tit" colspan="2">Propiedades</td></tr>
        <tr><td class="subtit"><label for="campo">Campo:</label></td> <td><textarea rows="1" id="campo" class="i_cmp"></textarea></td></tr>
        <tr><td class="subtit"><label for="estilo">Estilo:</label></td> <td><select id="estilo" class="i_cmp"></select></td></tr>
        <tr>
          <td class="subtit"><label for="tipo">Tipo:</label></td>
          <td>
            <select id="tipo" class="i_cmp">
              <option value="">Auto</option>
              <option value="string">Cadena</option>
              <option value="number">Número</option>
              <option value="date">Fecha</option>
            </select>
          </td>
        </tr>
        <tr><td class="subtit"><label for="alias">Alias:</label></td> <td><input id="alias" class="i_cmp"/></td></tr>
      </table>
    </div>

    <div id="f_rup">
      <table id="t_rup">
        <tr><td class="tit" colspan="2">Rupturas</td></tr>
        <tr><td class="subtit">Campo</td> <td class="subtit">Salto</td></tr>
      </table>
    </div>
  </div>

  <div id="bandas">
    <div id="tool_ban" class="ui-widget-header ui-corner-all">
      <button id="swp_w" class="b_banda">Mover a la izquierda</button>
      <button id="swp_e" class="b_banda">Mover a la derecha</button>
      <button id="swp_n" class="b_banda">Mover arriba</button>
      <button id="swp_s" class="b_banda">Mover abajo fila</button>
      <button id="add_cw" class="b_banda">Añadir columna a la izquierda</button>
      <button id="add_ce" class="b_banda">Añadir columna a la derecha</button>
      <button id="add_rn" class="b_banda">Añadir fila por arriba</button>
      <button id="add_rs" class="b_banda">Añadir fila por abajo</button>
      <button id="del_r" class="b_banda">Borrar fila</button>
      <button id="del_c" class="b_banda">Borrar columna</button>
      <button id="add_rup" title="Añadir bandas de ruptura">R+</button>
      <button id="del_rup" title="Borrar bandas de ruptura "class="b_banda">R-</button>
    </div>
    <p class="tit_band tit ui-widget-header ui-corner-all"> Cabecera </p>
    <table id="t_cab" class="t_banda">
      <tr>
        <td  prop={}>&nbsp;</td>
        <td  prop={}>&nbsp;</td>
      </tr>
    </table>
    <p id="tt_det" class="tit_band tit ui-widget-header ui-corner-all"> Detalle </p>
    <table id="t_det" class="t_banda">
      <tr>
        <td prop={}>&nbsp;</td>
        <td prop={}>&nbsp;</td>
      </tr>
    </table>
    <p class="tit_band tit ui-widget-header ui-corner-all"> Pie </p>
    <table id="t_pie" class="t_banda">
      <tr>
        <td prop={}>&nbsp;</td>
        <td prop={}>&nbsp;</td>
      </tr>
    </table>
  </div>
</div>

<div id="config" title="Configuración">
  <table id="t_config">
    <col width="35%">
    <col width="65%">
    <tr><td class="subtit"><label for="filt_emp">Filtrar empresa:</label></td> <td><input type="checkbox" checked id="filt_emp" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="filt_eje">Filtrar ejercicio:</label></td> <td><input type="checkbox" checked id="filt_eje" class="i_cmp"/></td></tr>
    <tr><td class="tit" colspan="2">SQL</td></tr>
    <tr><td class="subtit"><label for="select">Select:</label></td> <td><textarea rows="2" id="select" class="i_cmp"></textarea></td></tr>
    <tr><td class="subtit"><label for="join">Join:</label></td> <td><textarea rows="2" id="join" class="i_cmp"></textarea></td></tr>
    <tr><td class="subtit"><label for="where">Where:</label></td> <td><textarea rows="2" id="where" class="i_cmp"></textarea></td></tr>
    <tr><td class="subtit"><label for="orden">Orden:</label></td> <td><textarea rows="2" id="orden" class="i_cmp"></textarea></td></tr>
    <tr><td class="tit" colspan="2">ASPECTO</td></tr>
    <tr><td class="subtit"><label for="npagw">Nº Páginas ancho:</label></td> <td><input type="number" id="npagw" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="npagh">Nº Páginas alto:</label></td> <td><input id="npagh" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="pingrid">Pintar Rejilla:</label></td> <td><input type="checkbox" id="pingrid" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="tit_i">Título izquierda:</label></td> <td><input id="tit_i" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="tit_c">Título centro:</label></td> <td><input id="tit_c" class="i_cmp"/></td></tr>
    <tr><td class="subtit"><label for="tit_d">Título derecha:</label></td> <td><input id="tit_d" class="i_cmp"/></td></tr>
  </table>
</div>

<div id="lim" title="Límites">
  <div class="ui-widget-header ui-corner-all">
    <button id="b_add_lim">Añadir límite</button>
    <button id="b_del_lim">Borrar límite</button>
  </div>

  <table id="t_lim">
    <col width="15%">
    <col width="10%">
    <col width="15%">
    <col width="30%">
    <col width="15%">
    <col width="15%">
    <tr class="subtit">
      <td class="subtit">Nombre</td>
      <td class="subtit">Tipo</td>
      <td class="subtit">Valor</td>
      <td class="subtit">Propiedades</td>
      <td class="subtit">Where</td>
      <td class="subtit">Join</td>
    </tr>
  </table>
</div>

<div id="estilos" title="Estilos">
  <div class="ui-widget-header ui-corner-all">
    <button id="b_add_estilo">Añadir estilo</button>
    <button id="b_del_estilo">Borrar estilo</button>
  </div>

  <table id="t_estilos">
    <col width="10%">
    <col width="90%">
    <tr class="subtit">
      <td class="subtit">Nombre</td>
      <td class="subtit">Propiedades</td>
    </tr>
  </table>
</div>

<div id="grabar" title="Grabar">
  <label for="file_name">Archivo:</label><input id="filename" class="i_cmp"/>
</div>

<div id="abrir">
  <iframe id="f_abrir"></iframe>
</div>


<style>
  .centro {text-align: center;}
  .subtit {
    background-color: #f0f0f0;
  }
  .tit {
    background-color: #d3d3d3;
    text-align: center;
    margin-top: 1px;
    margin-bottom: 1px;
  }
  #titulo {
    margin-bottom: 2px;
  }
  #t_titulo  {
    background-color: #f0f0f0;
    border-collapse: collapse;
  }
  #campos {
    float: left;
    vertical-align: top;
    height: 400px;
  }
  #param {
    display: none;
    vertical-align: top;
  }
  #formus {
    float: left;
    margin-bottom: 5px;
  }
  #f_cmp, #f_rup, #bandas {
    float: left;
    margin-left: 5px;
    vertical-align: top;
  }
  #bandas {
    width: 500px;
  }
  #tree_campos {
    background-color: #d3d3d3;
    padding-left: 3px;
    padding-right: 5px;
    padding-top: 3px;
    padding-bottom: 10px;
  }
  .t_banda, #t_titulo, #t_estilos, #t_lim, #t_config {
    width: 100%;
    table-layout: fixed;
  }
  #param table, #param td, #t_estilos, #t_estilos td, #t_lim, #t_lim td {
    border: 1px solid black;
    border-collapse: collapse;
  }
  .i_cmp {
    border-width: 0;
    font: normal normal normal normal 1.1em/normal Arial, Helvetica, sans-serif;
  }
  /*.i_cmp:not(textarea) {*/
  .i_cmp {
    width: 100%;
  }

  #t_lim textarea {
    resize: vertical;
  }

  #f_abrir {
    width: 100%;
  }

  textarea {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
  }
</style>

<script>
  var tabla, fileName, abrirInforme = false;

  function selTabla(ui) {
    tabla = $(ui.item).attr('id');

    $("#solapas").css('display', 'none');
    $("#param").css('display', 'block');
    $("#tabla").html('Tabla: ' + $(ui.item).html());
    $("#botones").html(
      '<button id="b_config">Configuración</button>' +
      '<button id="b_lim">Límites</button>' +
      '<button id="b_estilos">Estilos</button>' +
      '<button id="b_save">Guardar</button>' +
      '<button id="b_run">Lanzar informe</button>'
    );
    $("#b_config").button({icons: {primary: "ui-icon-gear"}, text: false}).click(function(){$("#config").dialog("open");});
    $("#b_lim").button({icons: {primary: "ui-icon-triangle-2-n-s"}, text: false}).click(function(){$("#lim").dialog("open");});
    $("#b_estilos").button({icons: {primary: "ui-icon-pencil"}, text: false}).click(function(){$("#estilos").dialog("open");});
    $("#b_save").button({icons: {primary: "ui-icon-disk"}, text: false}).click(function(){$("#grabar").dialog("open");});
    $("#b_run").button({icons: {primary: "ui-icon-print"}, text: false}).click(function(){
      abrirInforme = true;
      if (fileName == undefined)
        $("#grabar").dialog("open");
      else
        grabaFic(fileName);
    });
    $("#tree_campos").tree({selectable: false, dataUrl: '/gi/campos?node=' + tabla, onCanSelectNode: function(node){
      return node.load_on_demand != undefined ? false : true;
    }});
  }

  $("#solapas").tabs();
  <% @tablas.each_key do |mod| %>
    $("#<%= mod %>_m").menu({select: function(event, ui) {selTabla(ui);}});
  <% end %>

  function genArrayBan(rows) {
    ar = [];
    rows.each(function() {
      r = [];
      $(this).children().each(function() {
        r.push(JSON.parse($(this).attr("prop")));
      });
      ar.push(r);
    });

    return(ar);
  }

  function grabaFic(file) {
    data = {tabla: tabla};
    $("#config :input").each(function() {
      th =$(this);
      if (th.attr("type") == "checkbox")
        data[th.attr("id")] = th.is(':checked');
      else if (th.attr("id") == 'join')
        data[th.attr("id")] = "[" + th.val() + "]";
      else
        data[th.attr("id")] = "%q(" + th.val() + ")";
    });

    data['cab'] = genArrayBan($("#t_cab tr"));
    data['det'] = genArrayBan($("#t_det tr"));
    data['pie'] = genArrayBan($("#t_pie tr"));
    data.rup = [];
    $("#t_rup [class^=rup]").each(function(){
      cl = $(this).attr("class");
      h = {};
      h.campo = $(this).find("textarea").val();
      h.salto = $(this).find("input").is(":checked");
      trup = $("table." + cl);
      h.cab = genArrayBan(trup.first().find("tr"));
      h.pie = genArrayBan(trup.last().find("tr"));
      data.rup.push(h);
    });
    /*
    data['cab'] = [];
    $("#t_cab tr").each(function() {
      r = [];
      $(this).children().each(function() {
        r.push(JSON.parse($(this).attr("prop")));
      });
      data['cab'].push(r);
    });
    */

    data['lim'] = {};
    $("#lim input").each(function() {
      l = $(this);
      data['lim'][l.val()] = l.parent().next().children().val();
    });

    data['style'] = {};
    $("#estilos input").each(function() {
      e = $(this);
      data['style'][e.val()] = e.parent().next().children().val();
    });

    ow = (file == fileName) ? 's' : 'n';
    $.post('/gi/graba_fic', {file: file, ow: ow, data: JSON.stringify(data)}, function(d){
      if (d == 's') {
        if (abrirInforme) {
          $("#f_abrir").attr("src", '/gi/edit/' + file);
          $("#abrir").dialog("open");
          abrirInforme = false;
        } else {
          fileName = file;
        }
        $("#grabar").dialog("close");
      } else {
        if (window.confirm('Ya existe el fichero. ¿Sobreescribir?')) {
          fileName = file;
          grabaFic(file);
          $("#grabar").dialog("close");
        }
      }
    });
  }

  $("#filename").keypress(function (e) {
    if (e.which == 13) {
      file = $(this).val();
      if (file.trim() == "") {
        alert('Nombre de archivo no válido');
        return;
      }

      grabaFic(file);
    }
  });

  // Diálogo de configuración

  $("#config").dialog({
    autoOpen: false,
    show: {effect: "blind", duration: 500},
    hide: {effect: "explode", duration: 500}
  });

  // Diálogo de límites

  $("#lim").dialog({
    autoOpen: false,
    width: 650,
    show: {effect: "blind", duration: 500},
    hide: {effect: "explode", duration: 500}
  });
  $("#t_lim tbody").sortable({items: "tr:not(.subtit)"});
  $("#b_add_lim").button({icons: {primary: "ui-icon-plus"}, text: false}).click(function(){addLim();});
  $("#b_del_lim").button({icons: {primary: "ui-icon-minus"}, text: false}).click(function(){delLim();});

  function addLim() {
    if (lastCmp && lastCmp.is("#lim :input"))
      elem = lastCmp.parent().parent();
    else
      elem = $("#t_lim tr").last();

    elem.after("<tr>" +
      "<td><input class='i_cmp'/></td>" +
      "<td><select class='i_cmp'>" +
        "<option value='eq'>Igual</option>" +
        "<option value='dh'>Desde/Hasta</option>" +
        "<option value='ge'>Desde</option>" +
        "<option value='le'>Hasta</option>" +
        "<option value='lk'>Contenido</option>" +
      "</select></td>" +
      "<td><input class='i_cmp'/></td>" +
      "<td><textarea class='i_cmp'></textarea></td>" +
      "<td><textarea class='i_cmp'></textarea></td>" +
      "<td><textarea class='i_cmp'></textarea></td>" +
      "</tr>");

    elem.next().find("input").first().focus();
  }

  function delLim() {
    if (lastCmp && lastCmp.is("#lim :input") && lastCmp.parent().parent().index() > 0) lastCmp.parent().parent().remove();
  }

  // Diálogo de estilos

  $("#estilos").dialog({
    autoOpen: false,
    width: 650,
    show: {effect: "blind", duration: 500},
    hide: {effect: "explode", duration: 500}
  });
  $("#t_estilos tbody").sortable({items: "tr:not(.subtit)"});
  $("#b_add_estilo").button({icons: {primary: "ui-icon-plus"}, text: false}).click(function(){addEstilo();});
  $("#b_del_estilo").button({icons: {primary: "ui-icon-minus"}, text: false}).click(function(){delEstilo();});

  function llenaEstilos() {
    est = "";
    $("#t_estilos input").each(function(){
      v = $(this).val();
      if (v.trim() != "") est += '<option value="' + (v == "def" ? "" : v) + '">' + v + '</option>';
    });
    v = $("#estilo").val();
    $("#estilo").html(est);
    $("#estilo").val(v);
  }

  $("#estilos").on("blur", "input", llenaEstilos);

  function addEstilo(name, val) {
    if (name == undefined) name = "";
    if (val == undefined) val = "";

    if (lastCmp && lastCmp.is("#estilos :input"))
      elem = lastCmp.parent().parent();
    else
      elem = $("#t_estilos tr").last();

    elem.after("<tr><td><input class='i_cmp' value='" + name +"'/></td><td><textarea class='i_cmp'>" + val + "</textarea></td></tr>");
    if (name == "") elem.next().find("input").focus();
  }

  function delEstilo() {
    if (lastCmp && lastCmp.is("#estilos :input") && lastCmp.parent().parent().index() > 1) lastCmp.parent().parent().remove();
    llenaEstilos();
  }

  function checkEstilo(e) {
    a = true;
    $("#t_estilos input").each(function() {
      if ($(this).val() == e) {
        a = false;
        return false;
      }
    });
    if (a) {
      n = e.slice(3);
      c = "0000000000".slice(10-n);
      addEstilo("dec" + n, ":def_d, {format_code: '#,##0." + c + "'}");
      llenaEstilos();
    }
  }

  /**
  $("#estilos").on("click", ":input", function(e){$("#b_del_estilo").button("enable");});
  $("#estilos").on("blur", ":input", function(e){$("#b_del_estilo").button("disable");});
  $("#b_del_estilo").button("disable");
   **/

  // Añadir estilos por defecto
  addEstilo("def", "{sz: 10}");
  addEstilo("def_c", ":def, {alignment: {horizontal: :center}}");
  addEstilo("def_d", ":def, {alignment: {horizontal: :right}}");
  addEstilo("def_n", ":def, {b: true}");
  addEstilo("def_nc", ":def_c, {b: true}");
  addEstilo("def_nd", ":def_d, {b: true}");
  addEstilo("int", ":def_d, {format_code: '#,##0'}");
  addEstilo("int_n", ":def_nd, :int");
  addEstilo("dec2", ":def_d, {format_code: '#,##0.00'}");
  addEstilo("dec2_n", ":def_n, :dec2");
  addEstilo("date", ":def_c, {format_code: 'dd-mm-yyyy'}");
  addEstilo("tit", ":def, {bg_color: '303030'}");
  addEstilo("tit_c", ":def_c, :tit");
  addEstilo("tit_d", ":def_d, :tit");
  addEstilo("borde", ":def, {border: {style: :thin, color: 'FF0000FF', edges: [:right]}}");
  llenaEstilos();

  $( "#grabar" ).dialog({
    autoOpen: false,
    show: {effect: "blind", duration: 500},
    hide: {effect: "explode", duration: 500}
  });

  $( "#abrir" ).dialog({
    autoOpen: false
  });

  function fullCampo(node) {
    node = node || $("#tree_campos").tree('getSelectedNode');
    if (node) {
      label = node.name;
      node = node.parent;
      while (node.name != undefined) {
        label = node.name + '.' + label;
        node = node.parent;
      }
       return(label);
    } else
      return('');
  }

  var celda, nRup = 0, nCol = 2, nCel = 6;

  function bBandaStatus() {
    $(".b_banda").button("enable");
    if (celda.prev().length == 0) $("#swp_w").button("disable");
    if (celda.next().length == 0) $("#swp_e").button("disable");
    if (celda.parent().prev().length == 0) $("#swp_n").button("disable");
    if (celda.parent().next().length == 0) $("#swp_s").button("disable");
    if (nCol == 1) $("#del_c").button("disable");
  }

  function setCell(c) {
    celda = c;
    $(".t_banda td").css("background-color", "#ffffff");
    celda.css("background-color", "#d3d3d3");
    bBandaStatus();
    $("#f_cmp .i_cmp").attr("disabled", false);
    prop = JSON.parse(celda.attr('prop'));
    $("#campo").val(prop['campo']);
    $("#estilo").val(prop['estilo']);
    $("#tipo").val(prop['tipo']);
    $("#alias").val(prop['alias']);

    $("#campo").focus();
  }

  $("#bandas").on('click', 'td', function() {
    if (window.event.ctrlKey) {
      if (lastCmp.is("#campo")) {
        ban_click = $(this).parentsUntil('div').last().attr('id');
        ban_act = celda.parentsUntil('div').last().attr('id');
        h_click = JSON.parse($(this).attr('prop'));
        ali = h_click.alias;
        v = $("#campo").val();

        if (v == "") {
          ini = true;
          v = "'='+";
        } else
          ini = false;

        if (ban_click == ban_act) {
          if (ban_click == "t_det" && window.event.shiftKey)
            $("#campo").val(v + ' tot(:' + ali + ', 0)');
          else
            $("#campo").val(v + ' cel(:' + ali + ')');
        } else if (ban_click == "t_det") {
          $("#campo").val(v + ' tot(:' + ali + ')');
        } else
          ini = false;

        if (ini) {
          h = JSON.parse(celda.attr('prop'));
          if (ban_click != ban_act) {
            h.alias = ali;
            $("#alias").val(ali);
            celda.html(ali);
          }
          h.estilo = h_click.estilo;
          $("#estilo").val(h.estilo);
          celda.attr('prop', JSON.stringify(h));
        }

        $("#campo").focus();
      }
    } else
      setCell($(this));
  });

  function noCell() {
    $(".b_banda").button("disable");
    $("#f_cmp .i_cmp").attr("disabled", true).val('');
  }

  $("#bandas").resizable({handles: 'e'});
  // Botones de bandas

  function genCell() {
    nCel += 1;
    //return('<td prop=\'{"alias":"c' + nCel + '"}\'>c' + nCel + '</td>');
    return('<td prop={}>&nbsp;</td>');
  }

  function genCol(ew) {
    i = celda.index() + 1;
    $(".t_banda td:nth-child(" + i + ")").each(function () {
      (ew == 'w') ? $(this).before(genCell()) : $(this).after(genCell());
    });
    nCol += 1;
    bBandaStatus();
  }

  function genCadRow() {
    cad = '<tr>';
    for (i = 0; i < nCol; i++) {
      cad += genCell();
    }
    cad += '</tr>';

    return cad;
  }

  function genRow(ns) {
    cad = genCadRow();
    (ns == 'n') ? $(celda.parent()).before(cad) : $(celda.parent()).after(cad);
    bBandaStatus();
  }

  function swpCell(cd) {
    prop = cd.attr('prop');
    cd.attr('prop', celda.attr('prop'));
    celda.attr('prop', prop);
    ht = cd.html();
    cd.html(celda.html());
    celda.html(ht);
    ti = cd.attr('title');
    cd.attr('title', celda.attr('title'));
    celda.attr('title', ti);
    setCell(cd);
  }

  $("#swp_w").button({icons: {primary: "ui-icon-arrowthick-1-w"}, text: false}).click(function(){swpCell(celda.prev());});
  $("#swp_e").button({icons: {primary: "ui-icon-arrowthick-1-e"}, text: false}).click(function(){swpCell(celda.next());});
  $("#swp_n").button({icons: {primary: "ui-icon-arrowthick-1-n"}, text: false}).click(function(){swpCell(celda.parent().prev().children().eq(celda.index()));});
  $("#swp_s").button({icons: {primary: "ui-icon-arrowthick-1-s"}, text: false}).click(function(){swpCell(celda.parent().next().children().eq(celda.index()));});
  $("#add_cw").button({icons: {primary: "ui-icon-triangle-1-w"}, text: false}).click(function(){genCol("w")});
  $("#add_ce").button({icons: {primary: "ui-icon-triangle-1-e"}, text: false}).click(function(){genCol("e")});
  $("#add_rn").button({icons: {primary: "ui-icon-triangle-1-n"}, text: false}).click(function(){genRow("n")});
  $("#add_rs").button({icons: {primary: "ui-icon-triangle-1-s"}, text: false}).click(function(){genRow("s")});
  $("#del_r").button({icons: {primary: "ui-icon-circle-minus"}, text: false}).click(function(){
    celda.parent().remove();
    noCell();
  });
  $("#del_c").button({icons: {primary: "ui-icon-circle-arrow-n"}, text: false, disabled: true}).click(function(){
    i = celda.index() + 1;
    $(".t_banda td:nth-child(" + i + ")").remove();
    noCell();
    nCol -= 1;
  });
  $("#add_rup").button().click(function(){
    nRup += 1;
    cl = 'rup_' + nRup;
    $("#tt_det").before(
      '<p class="' + cl + ' tit_band tit ui-widget-header ui-corner-all">Cabecera de Ruptura</p>' +
      '<table id="' + cl + '" class="' + cl + ' t_banda">' +
      genCadRow() +
      '</table>'
    );
    $("#t_det").after(
      '<p class="' + cl + ' tit_band tit ui-widget-header ui-corner-all">Pie de Ruptura</p>' +
      '<table class="' + cl + ' t_banda">' +
      genCadRow() +
      '</table>'
    );

    $("#t_rup tr").last().after(
      '<tr class="' + cl +'">' +
        '<td><textarea rows="1" class="i_cmp"></textarea></td>' +
        '<td><input type="checkbox" class="i_cmp"></td>' +
      '</tr>'
    );
    $("." + cl + " textarea").focus();
  });
  $("#del_rup").button().click(function(){
    cl = celda.parentsUntil('div').last().attr('class').split(/\s+/);
    $.each(cl, function(i, c) {
      if (c.slice(0,4) == 'rup_') {
        $('.' + c).remove();
        noCell();
        return false;
      }
    });
  });

  // Deshabilitar todos los botones de las bandas (hasta que se seleccione una celda)
  noCell();

  $("#bandas").on('dblclick', 'p', function(e) {
    if ($(this).next().children().children().length == 0)
      $(this).next().children().html(genCadRow());
  });

  var lastCmp;
  $("body").on("blur", ".i_cmp", function(e){
    lastCmp = $(this);
  });

  $("#f_cmp .i_cmp").blur(function(e){
    f = $(this);
    v = f.val().trim();
    p = f.attr('id');
    prop = JSON.parse(celda.attr('prop'));
    prop[p] = v;
    celda.attr('prop', JSON.stringify(prop));
    if (p == 'campo')
      celda.attr('title', v);
    else if (p == 'alias')
      celda.html(v == "" ? "&nbsp;" : v);
  });

  $('#tree_campos').bind('tree.dblclick', function(event) {
      if (lastCmp && lastCmp.is('textarea') && lastCmp.attr("disabled") != "disabled") {
        v = lastCmp.val();
        if (lastCmp.is("#param textarea")) {
          lastCmp.val(v + 'f.' + fullCampo(event.node));
          if (lastCmp.is("#f_cmp textarea") && $("#alias").val() == "") {
            a = (event.node.parent.name == undefined) ? a = "" : a = $(event.node.table.split('_')).get(-1) + '_';
            name = a + event.node.name;
            $("#alias").val(name);
            celda.html(name);
            esti = event.node.estilo;
            if (event.node.type == 'decimal') checkEstilo(esti);
            $("#estilo").val(esti);
            prop = JSON.parse(celda.attr('prop'));
            prop.alias = name;
            prop.estilo = esti;
            celda.attr('prop', JSON.stringify(prop));
            if (celda.is("#t_det td")) {
              cc = $("#t_cab tr").last().children().eq(celda.index());
              prop = JSON.parse(cc.attr('prop'));
              if (prop.alias == undefined || prop.alias == "") {
                prop.campo = "nt('" + event.node.name + "')";
                prop.alias = name;
                prop.estilo = "tit" + (event.node.ali == "i" ? "" : "_" + event.node.ali);
                cc.attr('prop', JSON.stringify(prop));
                cc.attr('title', prop.campo);
                cc.html(name);
              }
            }
          }
        } else
          lastCmp.val(v + event.node.table + '.' + event.node.name);

        lastCmp.focus();
      }
    }
  );

  $("body").on('keypress', 'textarea', function(e){
    if (e.which == 10) $(this).val($(this).val() + fullCampo());
  });

  $("document").tooltip();
  var zz;
</script>
