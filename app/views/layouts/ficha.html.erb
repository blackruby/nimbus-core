<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @titulo.nil? ? 'Nimbus' : @titulo %></title>
  <%= stylesheet_link_tag    "application", media: "all", "data-turbolinks-track" => true %>
  <%= javascript_include_tag "application", "data-turbolinks-track" => true %>
  <%= csrf_meta_tags %>
</head>

<body>
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <% if @head > 0 || @tabs.size > 0 %>
  <header class="mdl-layout__header">
    <% if @head > 0 %>
      <div class="mdl-layout__header-row">
        <span class="mdl-layout-title"> <%= @titulo %> </span>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
          <button title="Grabar (Alt-g)" class="cl-grabar mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect mdl-button--colored" onclick="mant_grabar()">
            <i class="material-icons">save</i>
          </button>
          &nbsp; &nbsp;
          <button title="Eliminar" class="cl-borrar mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect mdl-button--colored" onclick="mant_borrar()">
            <i class="material-icons">delete</i>
          </button>
          <% if @menu_r.size > 0 %>
            &nbsp; &nbsp;
            <button id="menu-r" class="mdl-button mdl-js-button mdl-button--icon">
              <i class="material-icons">more_vert</i>
            </button>

            <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="menu-r">
              <%  @menu_r.each_with_index {|m, i| %>
                <% m[:id] ||= '_mr_'+i.to_s %>
                <% if m[:id].starts_with?('tag_') %>
                  <%= m[:label].html_safe %>
                <% else %>
                  <li id="<%= m[:id] %>" class="mdl-menu__item" onclick="liFon(this, '<%= m[:accion] %>', '<%= m[:tipo] %>')"> <%= m[:label] %> </li>
                <% end %>
              <% } %>
            </ul>
          <% end %>
        </nav>
      </div>
    <% end %>

    <% if @tabs.size > 0 %>
      <div class="mdl-layout__tab-bar mdl-js-ripple-effect">
        <% @tabs.each_with_index {|t, i| %>
          <a id="h_<%= t %>" href="#t_<%= t %>" class="mdl-layout__tab <%= i==0 ? 'is-active' : '' %>" onclick="tabClick($('#t_<%= t %>'))"> <%= nt(t) %> </a>
        <% } %>
      </div>
    <% end %>
  </header>
  <% end %>

  <% if @head > 0 %>
    <div class="mdl-layout__drawer">
      <nav class="mdl-navigation">
        <a class="mdl-navigation__link" href="#" onclick="historico()">Histórico</a>
        <% if @menu_l.size > 0 %>
          <hr>
          <% @menu_l.each_with_index {|m, i| %>
            <% m[:id] ||= '_ml_'+i.to_s %>
            <% if m[:id].starts_with?('tag_') %>
              <%= m[:label].html_safe %>
            <% else %>
              <a id="<%= m[:id] %>" class="mdl-navigation__link" href="<%= m[:url] %>" target="_blank"> <%= nt(m[:label]) %> </a>
            <% end %>
          <% } %>
        <% end %>
      </nav>
    </div>
  <% end %>

  <main class="mdl-layout__content">
    <div class="page-content nim-div-tab" style="visibility: hidden">
      <%= gen_form({tab: 'pre'}) %>
      <%= yield :pre %>

      <% if @tabs.size > 0 %>
        <% @tabs.each_with_index {|t, i| %>
          <section class="mdl-layout__tab-panel <%= i==0 ? 'is-active' : '' %>" id="t_<%= t %>">
            <div class="page-content">
              <%= gen_form({tab: t}) %>
              <%= yield t.to_sym%>
              <% @hijos.each_with_index{|h, i| if h[:tab] == t then %>
                <iframe id="hijo_<%= i %>"></iframe>
              <% end } %>
            </div>
          </section>
        <% } %>
      <% end %>

      <%= gen_form({tab: 'post'}) %>
      <% @hijos.each_with_index{|h, i| if h[:tab] == 'post' then %>
        <iframe id="hijo_<%= i %>"></iframe>
      <% end } %>

      <%= yield %>
    </div>
  </main>
</div>

<%= yield :body %>

<% @dialogos.each {|d| %>
  <div id="<%= d[:id] %>" style="display: none">
    <%= gen_form({dlg: d[:id]}) %>
  </div>
<% } %>

<div id="dialog-nim-alert" style="display: none">
</div>

<div id="dialog-borrar" title="Borrado" style="display: none">
  <p>
    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
    El registro será eliminado.<br>¿Está seguro?
  </p>
</div>

</body>

<style>
  body {margin-top: 0px;}
  .mdl-grid {padding: 0;}
  .mdl-layout__content::-webkit-scrollbar {display: none;}
</style>

<script>
  $("#dialog-nim-alert").dialog({
    autoOpen: false,
    resizable: false,
    modal: true,
    width: "auto",
    buttons: {
      "Aceptar": function() {
        $(this).dialog("close");
      }
    }
  });

  $("#dialog-borrar").dialog({
    autoOpen: false,
    resizable: false,
    //height:170,
    //width: 350,
    modal: true,
    buttons: {
      "Sí": function() {
        $(this).dialog("close");
        mant_borrar_ok();
      },
      No: function() {
        $(this).dialog("close");
      }
    }
  });

  <% @dialogos.each {|d| %>
    $("#<%= d[:id] %>" ).dialog({
      autoOpen: false,
      resizable: false,
      width: "<%= d[:width] ? d[:width] : '100%' %>",
      height: "<%= d[:height] ? d[:height] : 'auto' %>",
      modal: true,
      title: "<%= d[:titulo] %>",
      buttons: {
        <% d[:botones].to_a.each {|b| %>
          "<%= b[:label] %>": function () {
            <% if b[:busy] %>
              ponBusy();
            <% end %>
            callFonServer("<%= b[:accion] %>", {}, quitaBusy);
            <%= (b[:close].nil? or b[:close]) ? '$(this).dialog("close");'.html_safe : '' %>
          },
        <% } %>
      }
    });
  <% } %>

  <%= gen_js %>
  <%= @ajax.html_safe %>

  function abreDialogo(d) {
    $("#" + d).dialog("open");
  }

  function historico() {
    <% if @fact.id and @fact.id > 0 %>
      /**
      window.open("/histo/" + _controlador + "/" + <%= @fact.id %>, "_blank", "location=no, menubar=no, status=no, toolbar=no" +
        ",height=800, width=1000" +
        ",left=" + (window.screenX + 10) +
        ",top=" + (window.screenY + 10)
      );
      **/
      window.open("/histo/" + _controlador + "/" + <%= @fact.id %>);
    <% end %>
  }

  function liFon(li, fon, tipo) {
    if ($(li).attr("disabled") == "disabled") return;
    if (typeof fon == 'function')
      fon.call();
    else if (tipo == 'dlg')
      abreDialogo(fon);
    else
      callFonServer(fon);
  }

  function redimWindow() {
    <% @hijos.each_with_index{|h, i| %>
    f = $("#hijo_<%= i %>");
    wh = $(window).height();
    fh = wh - f.offset().top;
    //if (fh < wh/2) f.height(wh/2); else f.height(fh);
    f.height(fh);
    <% } %>
  }

  // Ctr-k Habilita los campos clave
  $(document).keydown(function(e) {
    if (e.ctrlKey && e.which == 75) {
      e.preventDefault();
      $("<%= @fact.class.superclass.pk.map{|k| '#' + k}.join(',')%>").attr("disabled", false);
    } else if (e.altKey) {
      if (e.which == 70) { // Alt-f
        if (parent != self && $.isFunction(parent.searchBar)) {e.preventDefault(); parent.searchBar();}
      } else if (e.which == 86) { // Alt-v
        if (parent != self && $.isFunction(parent.gridCollapse)) {e.preventDefault(); parent.gridCollapse();}
      } else if (e.which == 78) { // Alt-n
        if (parent != self && $.isFunction(parent.newFicha)) {e.preventDefault(); parent.newFicha();}
      } else if (e.which == 66) { // Alt-b
        if (parent != self && $.isFunction(parent.pkSearch)) {e.preventDefault(); parent.pkSearch();}
      } else if (e.which == 65) { // Alt-a
        if (parent != self && $.isFunction(parent.newFicha)) {
          e.preventDefault();
          $(":focus").blur();
          mant_grabar(true);
        }
      } else if (e.which == 71) { // Alt-g
        e.preventDefault();
        var f = $(":focus");
        f.blur();
        mant_grabar();
        f.focus();
      }
    }
  });

  var hayCambios = false;

  window.onbeforeunload = function() {
    var jsHay = false;
    if (typeof jsCambios == "function") jsHay = jsCambios();
    if (hayCambios || jsHay) return('Hay cambios pendientes de grabar');
  };

  $(window).resize(redimWindow);

  $(window).load(function () {
    redimWindow();
    $(".nim-div-tab").css("visibility", "visible");
    //componentHandler.upgradeDom();
    if (parent != self && $.isFunction(parent.redimWindow)) parent.redimWindow();
    $("input,select,textarea").filter(":enabled[readonly!='readonly']").first().focus();
  });

  var _activeTab;
  function tabClick(tab) {
    _activeTab = tab;
    setTimeout(function(){
      if (typeof tabClickUsu == "function") tabClickUsu(tab);
      _activeTab.find(":input").filter(":enabled[readonly!='readonly']").first().focus();
    },100);
  }
</script>

</html>
